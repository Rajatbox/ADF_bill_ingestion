# ADF Carrier Billing Integration - Cursor Rules

## System Overview
You are working on a carrier billing integration system for Azure Data Factory (ADF).
The system transforms carrier-specific billing CSV files into a unified analytical schema.

## Two-Agent Delegation System

### üîß Setup Agent (Folder & File Collection)
**Trigger:** User says "integrate [Carrier]" or "add [Carrier]"

**Instructions:** Read and follow `.agents/setup_agent.md`

**Responsibilities:**
1. Create `[carrier]_transform/` folder with 6 empty files
2. Request CSV, stored procedure, and additional reference from user
3. STOP and wait - do NOT generate scripts
4. Hand off to Design Agent when files are provided

**Output:**
```
[carrier]_transform/
  ‚îú‚îÄ‚îÄ [carrier]_example_bill.csv           (user fills)
  ‚îú‚îÄ‚îÄ reference_stored_procedure.sql       (user fills)
  ‚îú‚îÄ‚îÄ additional_reference.md             (user fills - optional)
  ‚îú‚îÄ‚îÄ Insert_ELT_&_CB.sql                  (empty)
  ‚îú‚îÄ‚îÄ Sync_Reference_Data.sql              (empty)
  ‚îî‚îÄ‚îÄ Insert_Unified_tables.sql            (empty)
```

---

### üé® Design Agent (Script Generation)
**Trigger:** User provides CSV and stored procedure files, or says "generate scripts"

**Instructions:** Read and follow `.agents/design_agent.md`

**MUST READ BEFORE GENERATING:**
- `DESIGN_CONSTRAINTS.md` (10 rules you MUST apply)
- `[carrier]_example_bill.csv` (to understand structure)
- `reference_stored_procedure.sql` (to preserve business logic)
- `additional_reference.md` (for extra context, if populated)

**Responsibilities:**
1. Read all input files and create an implementation plan
2. Present the plan and ask clarifying questions to the user
3. Wait for user approval before proceeding
4. Generate delta table schema (1:1 with CSV)
5. Generate `Insert_ELT_&_CB.sql` (with transaction)
6. Generate `Sync_Reference_Data.sql` (no transaction)
7. Generate `Insert_Unified_tables.sql` (with unit conversions)
8. Provide 1 validation test query

**Output:** Implementation plan ‚Üí User approval ‚Üí 3 transform scripts + 1 test query

---

## Critical Rules

### ‚ùå NEVER DO THIS
- Modify `parent_pipeline/Load_to_gold.sql`
- Modify `parent_pipeline/LookupCarrierInfo.sql`
- Create README or extra documentation in carrier folder
- Create any new files unless explicitly mentioned in system prompt or user request
- Generate scripts before receiving CSV and stored procedure
- Generate scripts before presenting a plan and getting user approval
- Use `TRY_CAST` (use `CAST` for fail-fast)
- Store cost in `shipment_attributes` table
- Skip unit conversions (weight must be OZ, dimensions must be IN)
- Forget `carrier_id` in NOT EXISTS checks

### ‚úÖ ALWAYS DO THIS
- Read all input files including `additional_reference.md` (if populated)
- Create an implementation plan and present to user BEFORE generating scripts
- Ask clarifying questions and wait for user approval
- Read `DESIGN_CONSTRAINTS.md` before generating any scripts
- Apply all design constraints (including file-based processing)
- Use `@File_id` parameter for filtering (not `@lastrun`)
- Use transactions ONLY for `Insert_ELT_&_CB.sql`
- Join to `carrier_bill` for file-based filtering in Sync and Unified scripts
- File-based idempotency: Check `cb.file_id = @File_id` in carrier_bill NOT EXISTS
- Convert weight to OZ (LB √ó 16, KG √ó 35.274)
- Convert dimensions to IN (CM √∑ 2.54, MM √∑ 25.4)
- Include `carrier_id` in all NOT EXISTS checks
- Make scripts idempotent
- Return structured output (Status, counts, errors)

---

## Design Constraints Quick Reference

1. **Parent Pipeline:** Never modify - it's carrier-agnostic
2. **Transactions:** Only for `Insert_ELT_&_CB.sql` (invoice + line items)
3. **Type Conversion:** Direct CAST (fail fast on bad data)
4. **Idempotency:** NOT EXISTS with carrier_id AND file-based filtering
5. **Business Key:** (carrier_id, tracking_number) - enforced by UNIQUE INDEX
6. **Cost Calculation:** View calculates on-the-fly (NOT stored in table)
7. **Unit Conversions:** Weight ‚Üí OZ, Dimensions ‚Üí IN (REQUIRED)
8. **Script Returns:** Status, counts, error details
9. **Format Support:** Narrow (one row per charge) OR Wide (unpivot view)
10. **Execution Order:** ELT ‚Üí Sync ‚Üí Unified ‚Üí Load_to_gold
11. **File-Based Processing:** Use @File_id parameter, join carrier_bill, filter by file_id

---

## Reference Files

**Read for context:**
- `architecture.md` - System architecture and pipeline flow
- `schema.sql` - Database schema
- `fedex_transform/` - Complete working example (reference only, don't copy blindly)

**Must read for generation:**
- `DESIGN_CONSTRAINTS.md` - 10 rules to apply
- `.agents/setup_agent.md` - Setup phase instructions
- `.agents/design_agent.md` - Design phase instructions

---

## Example Workflow

```
User: "I want to integrate UPS"
  ‚Üì
You: [Follow .agents/setup_agent.md]
  - Create ups_transform/ with 6 empty files
  - Ask for CSV, stored procedure, and additional reference
  - STOP and wait

User: [Provides CSV, stored procedure, and optional additional reference]
  ‚Üì
You: [Follow .agents/design_agent.md - PLAN PHASE]
  - Read DESIGN_CONSTRAINTS.md
  - Read all user files (CSV, stored proc, additional reference)
  - Present implementation plan
  - Ask clarifying questions
  - STOP and wait for approval

User: [Approves plan / answers questions]
  ‚Üì
You: [Follow .agents/design_agent.md - GENERATION PHASE]
  - Generate delta table + 3 scripts
  - Provide validation test

User: "Looks good, deploy"
  ‚Üì
Done!
```

---

## Validation

After generating scripts, provide this ONE test query:

```sql
-- Test: File total vs charges total
WITH file_total AS (
    SELECT SUM([total_column]) AS expected
    FROM delta_[carrier]_bill
),
charges_total AS (
    SELECT SUM(amount) AS actual
    FROM shipment_charges sc
    JOIN shipment_attributes sa ON sa.id = sc.shipment_attribute_id
    WHERE sa.carrier_id = @Carrier_id
)
SELECT 
    expected, actual, ABS(expected - actual) AS difference,
    CASE WHEN ABS(expected - actual) < 0.01 THEN '‚úÖ PASS' ELSE '‚ùå FAIL' END AS result
FROM file_total, charges_total;
```

---

## Key Principles

- **Separation:** Setup collects, Design generates
- **Hard Stops:** Don't proceed without prerequisites
- **Constraints:** Apply DESIGN_CONSTRAINTS.md religiously
- **Reference:** Use fedex_transform/ as example, not template
- **Simplicity:** 3 scripts + 1 test, nothing more (no extra files)
- **No File Proliferation:** Don't create extra files, markdown docs, or helper scripts

---

## When in Doubt

1. Is it parent_pipeline? ‚Üí Don't touch
2. Missing prerequisites? ‚Üí Ask user, don't assume
3. Unsure about rule? ‚Üí Read DESIGN_CONSTRAINTS.md
4. Need example? ‚Üí Look at fedex_transform/
5. Complex logic? ‚Üí Preserve from reference_stored_procedure.sql and additional_reference.md
6. Not sure about mapping? ‚Üí Present plan first, ask user

